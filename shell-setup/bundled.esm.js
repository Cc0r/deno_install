var Y=class{env(t){return Deno.env.get(t)}stat(t){return Deno.stat(t)}statSync(t){return Deno.statSync(t)}get os(){return Deno.build.os}};async function le(e,t=new Y){let r=ke(e,t);if(r!=null)for(let n of r.pathItems){let i=n+e;if(r.pathExts){t.requestPermission?.(n);for(let s of r.pathExts){let a=n+e+s;if(await ae(t,a))return a}}else if(await ae(t,i))return i}}async function ae(e,t){try{return(await e.stat(t)).isFile}catch(r){if(r instanceof Deno.errors.PermissionDenied)throw r;return!1}}function ke(e,t){let r=t.os==="windows",n=r?";":":",i=t.env("PATH"),s=r?"\\":"/";if(i==null)return;return{pathItems:o(i).map(l=>f(l)),pathExts:a(),isNameMatch:r?(l,g)=>l.toLowerCase()===g.toLowerCase():(l,g)=>l===g};function a(){if(!r)return;let l=t.env("PATHEXT")??".EXE;.CMD;.BAT;.COM",g=o(l),He=e.toLowerCase();for(let Ue of g)if(He.endsWith(Ue.toLowerCase()))return;return g}function o(l){return l.split(n).map(g=>g.trim()).filter(g=>g.length>0)}function f(l){return l.endsWith(s)||(l+=s),l}}import{homedir as Fe}from"node:os";async function q(e){try{return await Deno.stat(e)}catch(t){if(t instanceof Deno.errors.NotFound||t instanceof Deno.errors.PermissionDenied&&(await Deno.permissions.query({name:"read",path:e})).state=="granted")return;throw t}}var b={writeTextFile:Deno.writeTextFile,readTextFile:Deno.readTextFile,async isExistingFile(e){return(await q(e))?.isFile??!1},async isExistingDir(e){return(await q(e))?.isDirectory??!1},pathExists(e){return q(e).then(t=>t!==void 0)},mkdir:Deno.mkdir,homeDir:Fe(),findCmd:le,getEnv(e){return Deno.env.get(e)},async runCmd(e,t){return await new Deno.Command(e,{args:t,stderr:"piped",stdout:"piped",stdin:"null"}).output()}};var u=globalThis.Deno?.build.os==="windows"||globalThis.navigator?.platform?.startsWith("Win")||globalThis.process?.platform?.startsWith("win")||!1;function p(e){if(typeof e!="string")throw new TypeError(`Path must be a string, received "${JSON.stringify(e)}"`)}function T(e,t){if(t.length>=e.length)return e;let r=e.length-t.length;for(let n=t.length-1;n>=0;--n)if(e.charCodeAt(r+n)!==t.charCodeAt(n))return e;return e.slice(0,-t.length)}function D(e,t,r=0){let n=!1,i=e.length;for(let s=e.length-1;s>=r;--s)if(t(e.charCodeAt(s))){if(n){r=s+1;break}}else n||(n=!0,i=s+1);return e.slice(r,i)}function O(e,t){if(p(e),e.length===0)return e;if(typeof t!="string")throw new TypeError(`Suffix must be a string, received "${JSON.stringify(t)}"`)}function C(e,t){if(e.length<=1)return e;let r=e.length;for(let n=e.length-1;n>0&&t(e.charCodeAt(n));n--)r=n;return e.slice(0,r)}function m(e){return e===47}function fe(e,t=""){O(e,t);let r=D(e,m),n=C(r,m);return t?T(n,t):n}function ce(e){return e===47}function c(e){return e===47||e===92}function h(e){return e>=97&&e<=122||e>=65&&e<=90}function ue(e,t=""){O(e,t);let r=0;if(e.length>=2){let s=e.charCodeAt(0);h(s)&&e.charCodeAt(1)===58&&(r=2)}let n=D(e,c,r),i=C(n,c);return t?T(i,t):i}function pe(e,t=""){return u?ue(e,t):fe(e,t)}function v(e){if(p(e),e.length===0)return"."}function me(e){v(e);let t=-1,r=!1;for(let n=e.length-1;n>=1;--n)if(m(e.charCodeAt(n))){if(r){t=n;break}}else r=!0;return t===-1?m(e.charCodeAt(0))?"/":".":C(e.slice(0,t),m)}function ge(e){v(e);let t=e.length,r=-1,n=-1,i=!0,s=0,a=e.charCodeAt(0);if(t>1)if(c(a)){if(r=s=1,c(e.charCodeAt(1))){let o=2,f=o;for(;o<t&&!c(e.charCodeAt(o));++o);if(o<t&&o!==f){for(f=o;o<t&&c(e.charCodeAt(o));++o);if(o<t&&o!==f){for(f=o;o<t&&!c(e.charCodeAt(o));++o);if(o===t)return e;o!==f&&(r=s=o+1)}}}}else h(a)&&e.charCodeAt(1)===58&&(r=s=2,t>2&&c(e.charCodeAt(2))&&(r=s=3));else if(c(a))return e;for(let o=t-1;o>=s;--o)if(c(e.charCodeAt(o))){if(!i){n=o;break}}else i=!1;if(n===-1){if(r===-1)return".";n=r}return C(e.slice(0,n),ce)}function y(e){return u?ge(e):me(e)}function $(e){if(p(e),e.length===0)return"."}function P(e,t,r,n){let i="",s=0,a=-1,o=0,f;for(let l=0;l<=e.length;++l){if(l<e.length)f=e.charCodeAt(l);else{if(n(f))break;f=47}if(n(f)){if(!(a===l-1||o===1))if(a!==l-1&&o===2){if(i.length<2||s!==2||i.charCodeAt(i.length-1)!==46||i.charCodeAt(i.length-2)!==46){if(i.length>2){let g=i.lastIndexOf(r);g===-1?(i="",s=0):(i=i.slice(0,g),s=i.length-1-i.lastIndexOf(r)),a=l,o=0;continue}else if(i.length===2||i.length===1){i="",s=0,a=l,o=0;continue}}t&&(i.length>0?i+=`${r}..`:i="..",s=2)}else i.length>0?i+=r+e.slice(a+1,l):i=e.slice(a+1,l),s=l-a-1;a=l,o=0}else f===46&&o!==-1?++o:o=-1}return i}function H(e){$(e);let t=m(e.charCodeAt(0)),r=m(e.charCodeAt(e.length-1));return e=P(e,!t,"/",m),e.length===0&&!t&&(e="."),e.length>0&&r&&(e+="/"),t?`/${e}`:e}function Q(...e){if(e.length===0)return".";e.forEach(r=>p(r));let t=e.filter(r=>r.length>0).join("/");return t===""?".":H(t)}function U(e){$(e);let t=e.length,r=0,n,i=!1,s=e.charCodeAt(0);if(t>1)if(c(s))if(i=!0,c(e.charCodeAt(1))){let o=2,f=o;for(;o<t&&!c(e.charCodeAt(o));++o);if(o<t&&o!==f){let l=e.slice(f,o);for(f=o;o<t&&c(e.charCodeAt(o));++o);if(o<t&&o!==f){for(f=o;o<t&&!c(e.charCodeAt(o));++o);if(o===t)return`\\\\${l}\\${e.slice(f)}\\`;o!==f&&(n=`\\\\${l}\\${e.slice(f,o)}`,r=o)}}}else r=1;else h(s)&&e.charCodeAt(1)===58&&(n=e.slice(0,2),r=2,t>2&&c(e.charCodeAt(2))&&(i=!0,r=3));else if(c(s))return"\\";let a;return r<t?a=P(e.slice(r),!i,"\\",c):a="",a.length===0&&!i&&(a="."),a.length>0&&c(e.charCodeAt(t-1))&&(a+="\\"),n===void 0?i?a.length>0?`\\${a}`:"\\":a:i?a.length>0?`${n}\\${a}`:`${n}\\`:n+a}function J(...e){if(e.forEach(s=>p(s)),e=e.filter(s=>s.length>0),e.length===0)return".";let t=!0,r=0,n=e[0];if(c(n.charCodeAt(0))){++r;let s=n.length;s>1&&c(n.charCodeAt(1))&&(++r,s>2&&(c(n.charCodeAt(2))?++r:t=!1))}let i=e.join("\\");if(t){for(;r<i.length&&c(i.charCodeAt(r));++r);r>=2&&(i=`\\${i.slice(r)}`)}return U(i)}function d(...e){return u?J(...e):Q(...e)}var{Deno:he}=globalThis,Je=typeof he?.noColor=="boolean"?he.noColor:!1,Ve=!Je;function V(e,t){return{open:`\x1B[${e.join(";")}m`,close:`\x1B[${t}m`,regexp:new RegExp(`\\x1b\\[${t}m`,"g")}}function ee(e,t){return Ve?`${t.open}${e.replace(t.regexp,t.open)}${t.close}`:e}function te(e){return ee(e,V([1],22))}function xe(e){return ee(e,V([3],23))}function re(e){return ee(e,V([34],39))}var et=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TXZcf-nq-uy=><~]))"].join("|"),"g");function Ce(e){return e.replace(et,"")}var L=new TextEncoder,rt=new TextDecoder;async function*nt(){e:for(;;){let e=new Uint8Array(8),t=await Deno.stdin.read(e);if(t==null)break;if(t===3){if(e[0]===27&&e[1]===91)switch(e[2]){case 65:yield 0;continue;case 66:yield 1;continue;case 67:yield 3;continue;case 68:yield 2;continue}}else if(t===1)switch(e[0]){case 3:break e;case 13:yield 4;continue;case 32:yield 5;continue;case 127:yield 6;continue}let r=Ce(rt.decode(e.subarray(0,t??0)));r.length>0&&(yield r)}}function W(e,t){let r=0;for(;r<t.byteLength;)r+=e.writeSync(t.subarray(r))}var it=(...e)=>{let t=Object.create(null);for(let r=0;r<e.length;r++){let n=e[r];t[n.charAt(0)]=n.charCodeAt(0)}return t};function ot(e){throw new Error("unreachable")}var w=it("A","B","C","D","G","0","K");function k(e,t,r){let n=[27,91];switch(r!=null&&n.push(...L.encode(r.toString())),t){case 0:n.push(w.A);break;case 1:n.push(w.B);break;case 2:n.push(w.D);break;case 3:n.push(w.C);break;case 4:n.push(w.G);break;default:ot(t)}let i=new Uint8Array(n);W(e,i)}function st(e){W(e,new Uint8Array([27,91,w[0],w.K]))}function at(e){W(e,L.encode("\x1B[?25l"))}function lt(e){W(e,L.encode("\x1B[?25h"))}var Ae=Promise.resolve();function ft(e){let t=Ae,r=(async()=>{try{await t}catch{}at(Deno.stdout);try{Deno.stdin.setRaw(!0);try{return await e()}finally{Deno.stdin.setRaw(!1)}}finally{lt(Deno.stdout)}})();return Ae=r,r}function be(e){k(e,4),st(e)}var F=0;function E(e,t){for(;F>0;)be(e),k(e,0),F--;be(e);for(let[r,n]of t.entries()){k(e,4);let i="";r<t.length-1&&(i=`
`,F++),e.writeSync(L.encode(n+i))}k(e,4)}function we(e){return F=0,ft(async()=>{E(Deno.stdout,e.render());for await(let t of nt()){let r=e.onKey(t);if(r!=null)return E(Deno.stdout,[]),e.noClear&&(E(Deno.stdout,e.render()),console.log()),r;E(Deno.stdout,e.render())}E(Deno.stdout,[])})}function Re(e){if(e==null)Deno.exit(120);else return e}async function Pe(e){let t=await ct(e);return Re(t)}function ct(e){let t={title:e.message,activeIndex:0,items:e.options.map(f=>(typeof f=="string"&&(f={text:f}),{selected:f.selected??!1,text:f.text})),hasCompleted:!1},{selected:r="[x]",unselected:n="[ ]",pointer:i=">",listBullet:s="-",messageStyle:a=f=>te(re(f))}=e.styling??{},o={selected:r,unselected:n,pointer:i,listBullet:s,messageStyle:a};return we({message:e.message,noClear:e.noClear,render:()=>ut(t,o),onKey:f=>{switch(f){case 0:case"k":t.activeIndex===0?t.activeIndex=t.items.length-1:t.activeIndex--;break;case 1:case"j":t.activeIndex=(t.activeIndex+1)%t.items.length;break;case 5:{let l=t.items[t.activeIndex];l.selected=!l.selected;break}case 4:return t.hasCompleted=!0,t.items.map((l,g)=>[l,g]).filter(([l])=>l.selected).map(([,l])=>l)}}})}function ut(e,t){let r=[];if(r.push(t.messageStyle(e.title)),e.hasCompleted)if(e.items.some(n=>n.selected))for(let n of e.items)n.selected&&r.push(`${" ".repeat(t.pointer.length+t.selected.length-t.listBullet.length-2)}${t.listBullet} ${n.text}`);else r.push(xe(" <None>"));else for(let[n,i]of e.items.entries()){let s=n===e.activeIndex?`${t.pointer} `:`${" ".repeat(t.pointer.length+1)}`;r.push(`${s}${i.selected?t.selected:t.unselected} ${i.text}`)}return r}async function Se(e,t){let r=await pt(e,t);return Re(r)}function pt(e,t){let r=typeof e=="string"?{message:e,...t}:e;return mt(r)}function mt(e){let{messageStyle:t=i=>te(re(i))}=e.styling??{},r={messageStyle:t},n={title:e.message,default:e.default,inputText:"",hasCompleted:!1};return we({message:e.message,noClear:e.noClear,render:()=>gt(n,r),onKey:i=>{switch(i){case"Y":case"y":n.inputText="Y";break;case"N":case"n":n.inputText="N";break;case 6:n.inputText="";break;case 4:if(n.inputText.length===0){if(n.default==null)return;n.inputText=n.default?"Y":"N"}return n.hasCompleted=!0,n.inputText==="Y"?!0:n.inputText==="N"?!1:n.default}}})}function gt(e,t){return[t.messageStyle(e.title)+" "+(e.hasCompleted?"":e.default==null?"(Y/N) ":e.default?"(Y/n) ":"(y/N) ")+e.inputText+(e.hasCompleted?"":"\u2588")]}var{isExistingDir:dt,mkdir:ht}=b;function G(e,t){return new Error(e,{cause:t})}async function N(e,t){let r=await Promise.all(e.map(n=>t(n)));return e.filter((n,i)=>r[i])}function ne(e,t){let r=b.getEnv(e);return t(r)}function I(e){return ne("SHELL",t=>t!==void 0&&t.includes(e))}function B(e){console.error(`%cwarning%c: ${e}`,"color: yellow","color: inherit")}function ye(e){console.error(`%cinfo%c: ${e}`,"color: green","color: inherit")}async function _(e){await dt(e)||await ht(e,{recursive:!0})}function ie(e,t){return e.endsWith(t)?e:e+t}function oe(e,t){return e.startsWith(t)?e:t+e}var{isExistingFile:Ee,writeTextFile:xt,homeDir:S,findCmd:_e,runCmd:Ct,getEnv:At,pathExists:bt}=b,z=class{constructor(t,r){this.name=t;this.contents=r}equals(t){return this.name===t.name&&this.contents===t.contents}async write(t){let r=d(t,this.name);try{return await xt(r,this.contents),!0}catch(n){if(n instanceof Deno.errors.PermissionDenied)return!1;throw G(`Failed to write ${this.name} file to ${r}`,n)}}},Te=e=>new z("env",`#!/bin/sh
# deno shell setup; adapted from rustup
# affix colons on either side of $PATH to simplify matching
case ":\${PATH}:" in
    *:"${e}/bin":*)
        ;;
    *)
        # Prepending path in case a system-installed deno executable needs to be overridden
        export PATH="${e}/bin:$PATH"
        ;;
esac
`),De=e=>`. "${e}/env"`,M=class{name="sh";supportsCompletion=!1;exists(){return!0}rcfiles(){return[d(S,".profile")]}rcsToUpdate(){return this.rcfiles()}},j=class{name="bash";get supportsCompletion(){return Deno.build.os==="darwin"?"not recommended on macOS":!0}async exists(){return(await this.rcsToUpdate()).length>0}rcfiles(){return[".bash_profile",".bash_login",".bashrc"].map(t=>d(S,t))}rcsToUpdate(){return N(this.rcfiles(),Ee)}completionsFilePath(){return"/usr/local/etc/bash_completion.d/deno.bash"}completionsSourceString(){return`source ${this.completionsFilePath()}`}},K=class{name="zsh";supportsCompletion=!0;async exists(){return!!(I("zsh")||await _e("zsh"))}async getZshDotDir(){let t;if(I("zsh"))t=At("ZDOTDIR");else{let r=await Ct("zsh",["-c","echo -n $ZDOTDIR"]),n=new TextDecoder().decode(r.stdout).trim();t=n.length>0?n:void 0}return t}async rcfiles(){return[await this.getZshDotDir(),S].map(r=>r?d(r,".zshrc"):void 0).filter(r=>r!==void 0)}async rcsToUpdate(){let t=await N(await this.rcfiles(),Ee);return t.length===0&&(t=await this.rcfiles()),t}async completionsFilePath(){let t=await this.getZshDotDir();return t||(t=d(S,".zsh")),d(t,"completions","_deno.zsh")}async completionsSourceString(){let t=await this.completionsFilePath(),r=y(t),n=`# Add deno completions to search path
if [[ ":$FPATH:" != *":${r}:"* ]]; then export FPATH="${r}:$FPATH"; fi`,i=await this.getZshDotDir()??S,s;return(await N([".zcompdump",".oh_my_zsh",".zprezto"],a=>bt(d(i,a)))).length==0&&(s=`# Initialize zsh completions (added by deno install script)
autoload -Uz compinit
compinit`),{prepend:n,append:s}}},Z=class{name="fish";supportsCompletion=!0;async exists(){return!!(I("fish")||await _e("fish"))}fishConfigDir(){return ne("XDG_CONFIG_HOME",r=>{if(r)return d(r,"fish")})??d(S,".config","fish")}rcfiles(){return[d(this.fishConfigDir(),"conf.d/deno.fish")]}rcsToUpdate(){return this.rcfiles()}envScript(t){let r=`
# deno shell setup
if not contains "${t}/bin" $PATH
  # prepend to path to take precedence over potential package manager deno installations
  set -x PATH "${t}/bin" $PATH
end
`;return new z("env.fish",r)}sourceString(t){return`source "${t}/env.fish"`}completionsFilePath(){return d(this.fishConfigDir(),"completions","deno.fish")}};var{readTextFile:Oe,runCmd:wt,writeTextFile:ve}=b;async function Rt(e){let t=new Set,r=[],n=new TextDecoder;for(let i of e){if(!i.supportsCompletion){r.push(null);continue}try{let s=await i.completionsFilePath?.();if(!s){r.push(null);continue}await _(y(s));let a=await wt(Deno.execPath(),["completions",i.name]);if(!a.success)throw new Error(`deno completions subcommand failed, stderr was: ${n.decode(a.stderr)}`);let o=n.decode(a.stdout);if(!o){B(`Completions were empty, skipping ${i.name}`),r.push("fail");continue}let f=null;try{f=await Oe(s)}catch(l){if(!(l instanceof Deno.errors.NotFound))throw l}f!==o&&(f!==null&&B(`an existing completion file for deno already exists at ${s}, but is out of date. overwriting with new contents`),await ve(s,o)),r.push("success"),t.add(s)}catch(s){B(`Failed to install completions for ${i.name}: ${s}`),r.push("fail");continue}}return r}var se=class{constructor(t){this.backupDir=t}backedUp=new Set;async add(t,r){if(this.backedUp.has(t))return;let n=d(this.backupDir,pe(t))+".bak";ye(`backing '${t}' up to '${n}'`),await Deno.writeTextFile(n,r),this.backedUp.add(t)}};async function Pt(e,t){for(let r of e){if(!r.supportsCompletion)continue;let n=await r.completionsSourceString?.();if(n)for(let i of await r.rcsToUpdate())await $e(i,n,t)}}async function St(e,t){let r=new Array,n=0;for(;n<e.length;){let s=(e[n].envScript??Te)(t);if(!r.some(a=>a.equals(s)))if(await s.write(t))r.push(s);else continue;n++}}async function $e(e,t,r){let n="",i="";if(typeof t=="string"?i=t:(n=t.prepend??"",i=t.append??""),!n&&!i)return!1;let s;try{s=await Oe(e),n&&(s.includes(n)?n="":n=ie(n,`
`)),i&&(s.includes(i)?i="":s.endsWith(`
`)||(i=oe(i,`
`)))}catch{n=n&&ie(n,`
`),i=i&&oe(i,`
`)}if(!n&&!i)return!1;s!==void 0&&await r.add(e,s),await _(y(e));try{return await ve(e,n+(s??"")+i,{create:!0}),!0}catch(a){if(a instanceof Deno.errors.PermissionDenied||a instanceof Deno.errors.NotCapable)return!1;throw G(`Failed to update shell rc file: ${e}`,a)}}async function yt(e,t,r){for(let n of e){let i=await(n.sourceString??De)(t);for(let s of await n.rcsToUpdate())await $e(s,i,r)}}var Et=[new M,new j,new K,new Z];async function _t(){let e=[];for(let t of Et)await t.exists()&&e.push(t);return e}async function Tt(e,t){let r=await _t();await St(r,e);let n=new se(t);await Se("Edit shell configs to add deno to the PATH?",{default:!0})&&(await _(t),await yt(r,e,n),console.log(`
Deno was added to the PATH.
You may need to restart your shell for it to become available.
`));let i=r.filter(o=>o.supportsCompletion!==!1),a=(await Pe({message:"Set up completions?",options:i.map(o=>{let f=typeof o.supportsCompletion=="string"?` (${o.supportsCompletion})`:"";return o.name+f})})).map(o=>i[o]);if(a.length>0){await _(t);let o=await Rt(a);await Pt(a.filter((f,l)=>o[l]!=="fail"),n)}}async function Dt(){if(Deno.build.os==="windows"||!Deno.stdin.isTerminal())return;if(Deno.args.length===0)throw new Error("Expected the deno install directory as the first argument");let e=Deno.args[0].trim(),t=d(e,".shellRcBackups");await Tt(e,t)}import.meta.main&&await Dt();
